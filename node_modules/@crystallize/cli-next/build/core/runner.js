import { spawn } from 'child_process';
export default async (command, onStdOut, onStdErr, batchingInterval = 1000) => {
    const outs = [];
    const errs = [];
    const interval = setInterval(() => {
        if (onStdOut) {
            onStdOut(Buffer.from(outs.join('\n'), 'utf-8'));
        }
        if (onStdErr) {
            onStdErr(Buffer.from(errs.join('\n'), 'utf-8'));
        }
    }, batchingInterval);
    return new Promise(function (resolve, reject) {
        const process = spawn(command[0], command.slice(1));
        if (onStdOut) {
            process.stdout.on('data', (data) => {
                const text = data.toString();
                const lines = text.split('\n').filter((l) => l.length > 0);
                outs.push(...lines);
            });
        }
        if (onStdErr) {
            process.stderr.on('data', (data) => {
                const text = data.toString();
                const lines = text.split('\n').filter((l) => l.length > 0);
                errs.push(...lines);
            });
        }
        process.on('error', (error) => {
            clearInterval(interval);
            reject(error);
        });
        process.on('close', (code) => {
            clearInterval(interval);
            resolve(code);
        });
    });
};
